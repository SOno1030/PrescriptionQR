# PrescriptionQR
# ダミー処方箋QRコード生成Webアプリ 要件定義書

### 1. 概要と目的

**1.1. アプリケーションの目的**
新人薬剤師の研修を目的とし、処方箋の入力からJAHIS（保健医療福祉情報システム工業会）標準仕様に準拠したQRコードの生成・表示までをシミュレーションできるWebアプリケーションを開発する。利用者は本アプリを通じて、処方箋データの構造とQRコード化のプロセスを実践的に学習できる。

**1.2. ターゲットユーザー**
* 新人薬剤師、薬学生

**1.3. 開発の前提**
* 本アプリケーションは研修目的であり、実際の患者情報や医療行為には使用しない。
* 入力されるデータはダミーデータであることを前提とする。

---

### 2. システム構成・技術要件

**2.1. 全体構成**
サーバーサイドでHTMLを生成する、シンプルなWebアプリケーションとする。データベースは不要。

**2.2. 技術スタック**
* **バックエンド**: Python 3.9以上, Flask
* **QRコード生成ライブラリ**: `qrcode` (Pillowを含む)
* **フロントエンド**: HTML5, CSS3, JavaScript (入力フォームの動的な制御にのみ使用)
* **文字コード**:
    * ソースコード・HTML: UTF-8
    * QRコードにエンコードするデータ: **Shift_JIS**

---

### 3. 機能要件

**3.1. 画面仕様**

本アプリケーションは、以下の2画面で構成される。

**3.1.1. 処方箋入力画面 (`/`)**

* **目的**: ダミーの処方箋情報を入力するためのフォーム画面。
* **レイアウト**:
    * 以下のセクションに分かれた入力フォームを配置する。
        * 患者情報
        * 保険医療機関情報
        * 処方箋交付年月日
        * 医師情報
        * 処方薬剤情報
    * 各入力項目の詳細は「4. データ仕様」を参照。
* **動的フォーム**:
    * 「処方薬剤情報」セクションには、「薬剤を追加」ボタンを設置する。
    * このボタンをクリックすると、JavaScriptによって薬剤入力欄のセット（薬剤名、用法・用量、日数など）が動的に追加される。最低1つ、最大10個まで追加可能とする。
    * 各薬剤入力欄の隣には「削除」ボタンを配置し、その欄を削除できるようにする。
* **アクション**:
    * フォーム下部に「QRコード生成」ボタンを配置する。
    * クリックすると、入力内容をサーバーにPOST送信する。

**3.1.2. QRコード表示画面 (`/result`)**

* **目的**: 入力された処方箋内容の確認と、生成されたQRコードを表示する画面。
* **レイアウト**:
    * **入力内容のサマリー**: 入力画面で入力された情報を、整形して読みやすく表示する。
    * **QRコード表示エリア**: 生成されたJAHIS準拠のQRコード画像を中央に大きく表示する。
* **アクション**:
    * 「入力画面に戻る」ボタンを配置し、クリックすると処方箋入力画面に遷移する。

**3.2. 機能仕様**

**3.2.1. 処方箋データ処理機能 (バックエンド)**

* **リクエスト受信**: 処方箋入力画面からのPOSTリクエストを受け取る。
* **データバリデーション**:
    * 必須項目（患者氏名、生年月日、交付年月日、薬剤名など）が入力されているか簡易的なチェックを行う。
    * エラーがある場合は、エラーメッセージと共に処方箋入力画面を再表示する。
* **JAHISデータ文字列生成**:
    * 受け取ったフォームデータを、後述の「4.2. JAHIS QRコード データフォーマット仕様」に従い、カンマ区切りの文字列に変換する。
    * この際、文字列全体を **Shift_JIS** でエンコードする。

**3.2.2. QRコード生成・表示機能 (バックエンド)**

* **準拠規格**: JAHIS 電子版お薬手帳データフォーマット仕様書 **Ver.2.4**
* **QRコード仕様**:
    * **モデル**: モデル2
    * **誤り訂正レベル**: M (中)
* **生成プロセス**:
    1.  `qrcode`ライブラリを使用し、Shift_JISにエンコード済みのJAHISデータ文字列からQRコードオブジェクトを生成する。
    2.  生成したQRコードを画像データ（PNG形式）に変換する。
    3.  画像ファイルをサーバーに保存するのではなく、**Base64エンコード**し、文字列としてHTMLに直接埋め込む (`<img src="data:image/png;base64,..." >`)。これにより、一時ファイルの管理が不要になる。
    4.  処方箋サマリー情報とBase64エンコードされたQRコード画像をテンプレートに渡し、QRコード表示画面をレンダリングしてユーザーに返す。

---

### 4. データ仕様

**4.1. 処方箋入力フォーム項目**

| セクション | 項目名 | 型 | 必須 | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **患者情報** | 氏名（漢字） | text | ✔ | 例: 山田 太郎 |
| | 氏名（カナ） | text | ✔ | 例: ヤマダ タロウ |
| | 生年月日 | date | ✔ | YYYY-MM-DD形式 |
| | 性別 | radio | ✔ | 男性 / 女性 |
| **保険医療機関情報** | 病院・診療所名 | text | ✔ | 例: ○○大学医学部附属病院 |
| | 医療機関電話番号 | text | ✔ | 例: 03-1234-5678 |
| | 都道府県コード | number | ✔ | 例: 13 (東京都) |
| | 点数表 | select | ✔ | 1:医科, 3:歯科 |
| | 医療機関コード | text | ✔ | 7桁の数字。例: 1234567 |
| **処方箋情報** | 交付年月日 | date | ✔ | YYYY-MM-DD形式 |
| **医師情報** | 医師氏名 | text | | 例: 鈴木 一郎 |
| **処方薬剤情報 (※動的追加)** | 薬剤名 | text | ✔ | 例: カロナール錠200 200mg |
| | 1回量 | number | ✔ | 例: 1 |
| | 単位 | text | ✔ | 例: 錠 |
| | 1日服用回数 | number | ✔ | 例: 3 |
| | RP内日数 | number | ✔ | 例: 7 |
| | 用法 | text | ✔ | 例: 毎食後 |


**4.2. JAHIS QRコード データフォーマット仕様 (Ver.2.4準拠)**

QRコードに格納するデータは、以下の形式のカンマ区切り文字列とする。全体を **Shift_JIS**でエンコードすること。

```csv
JAHIS,2.4,[都道府県コード][点数表][医療機関コード],,,[患者氏名],[カナ氏名],[生年月日(YYYYMMDD)],[性別(1:男,2:女)],,[保険者番号],,,,[交付年月日(YYYYMMDD)],[処方箋有効期間],
,[医師氏名],,,
;1,[RP番号],[薬剤名],,[1回量],[単位],,[1日服用回数],[RP内日数],[用法],,,,,,
;1,[RP番号],[薬剤名],,[1回量],[単位],,[1日服用回数],[RP内日数],[用法],,,,,,
... (薬剤の数だけ繰り返す)
